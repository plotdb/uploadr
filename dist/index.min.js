!function(){var a;function o(e,t){var r,n={}.hasOwnProperty;for(r in t)n.call(t,r)&&(e[r]=t[r]);return e}(a={ext:{},assets:{thumbholder:"data:image/svg+xml,"+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="-5400 -5400 12000 12000"><rect width="12000" height="12000" x="-5400" y="-5400" fill="#ccc"/><path fill="#777" d="M1099.7 345.4v-.4a49.8 49.8 0 0 0-9.4-24.6l-.2-.2-1.2-1.5-.3-.4-1.3-1.4c0-.2-.2-.3-.3-.5a50 50 0 0 0-1.7-1.8l-300-300-1.8-1.6-.4-.4-1.5-1.2c0-.2-.2-.3-.4-.4l-1.5-1.2s-.2 0-.3-.2l-1.7-1.2A49.7 49.7 0 0 0 754.8.2h-.3A50.3 50.3 0 0 0 750 0H150a50 50 0 0 0-50 50v1100a50 50 0 0 0 50 50h900a50 50 0 0 0 50-50V350a49.7 49.7 0 0 0-.2-4.6zM800 170.7 929.3 300H800V170.7zM200 1100V100h500v250a50 50 0 0 0 50 50h250v700H200z"/></svg>')},utils:{parseDate:function(e){return e?new Date(e).toLocaleString("zh-TW",{timeZoneName:"short",hour12:!1}).replace(/[\[\]]/g,"").replace(/\s*GMT/,""):"n/a"},parseSize:function(e){var t,r,n;return!(e=+(e=null==e?0:e))||isNaN(e)?"0 B":(t=["B","KB","MB","GB","TB","PB"],r=(r=Math.floor(Math.log(e)/Math.log(1024)))<(n=t.length)?r:n,(e/Math.pow(1024,r)).toFixed(1)+(t[r]||""))}},i18n:{en:{"Drag & drop":"Drag & drop","file(s) here":"file(s) here",Name:"Name",Size:"Size","Modified Date":"Modified Date","Add File ...":"Add File ...",div:"div",Upload:"Upload",Clear:"Clear",Close:"Close","Load More":"Load More","End of List":"End of List",Reload:"Reload"},"zh-TW":{"Drag & drop":"拖拉檔案","file(s) here":"至此處",Name:"檔名",Size:"檔案大小","Modified Date":"修改時間","Add File ...":"增加檔案 ...",Upload:"上傳",Clear:"清除",Close:"關閉","Load More":"載入更多","End of List":"列表結尾",Reload:"重新載入"}},uploader:function(e){var t,r,n,i=this;if(this._={evthdr:{},files:[],opt:o({},e=null==e?{}:e),accept:(e.accept||"").split(",").map(function(e){return"."+e.replace(".","")}),root:"string"==typeof e.root?document.querySelector(e.root):e.root,i18n:e.i18n},this._.opt.provider=e.provider||{host:"native",config:{route:"/api/uploadr"}},this._.i18n)for(t in r=a.i18n)n=r[t],this._.i18n.addResourceBundle(t,"@plotdb/uploadr:uploader",n,!0,!0);return this.init=proxise.once(function(){return i._init()}),this._.root||console.warn("[@plotdb/uploadr] warning: no node found for root ",e.root),this.init(),this}}).uploader.prototype=o(Object.create(Object.prototype),{on:function(e,r){var n=this;return(Array.isArray(e)?e:[e]).map(function(e){var t;return((t=n._.evthdr)[e]||(t[e]=[])).push(r)})},fire:function(e){for(var t,r,n,i,o=[],u=[],a=1,l=arguments.length;a<l;++a)u.push(arguments[a]);for(t=u,a=0,n=(r=this._.evthdr[e]||[]).length;a<n;++a)i=r[a],o.push(i.apply(this,t));return o},files:function(){return this._.files||[]},i18n:function(r){var n=this;if(this._.i18n)return Array.from(this._.root.querySelectorAll("[t]")).map(function(e){var t;return(t=e.getAttribute("t"))||e.setAttribute("t",t=e.textContent),e.textContent=n._.i18n.t(t,{ns:"@plotdb/uploadr:uploader",lng:r})})},_init:function(){var n=this;return Promise.resolve().then(function(){return n._.view=new ldview({root:n._.root,action:{input:{input:function(e){var r=e.node;return n.set(r.files).then(function(e){var t;if(r.value=null,t=r.form)return t.reset()})}},click:{upload:function(e){e.node;return n.upload().then(function(e){return n.clear(),e})},clear:function(e){e.node;return n.clear()}},drop:{drop:function(e){e.node;var t,e=e.evt;return e.preventDefault(),e=Array.from(e.dataTransfer.files),n._.accept&&(t=new RegExp("."+n._.accept.split(",").join("|")+"$"),e=e.filter(function(e){return!!t.exec(e.name)})),n.set(e)}},dragover:{drop:function(e){return e.evt.preventDefault()}}},init:{loader:function(e){e=e.node;if("undefined"!=typeof ldloader&&null!==ldloader)return n._.loader=new ldloader({root:e})}},handler:{input:function(e){e=e.node;return n._.accept?e.setAttribute("accept",n._.accept):e.removeAttribute("accept")},file:{list:function(){return n._.files||[]},view:{action:{click:{delete:function(e){var e=e.ctx;if(~(e=n._.files.indexOf(e)))return n._.files.splice(e,1),n._.view.render("file")}}},text:{name:function(e){return e.ctx.file.name},size:function(e){e=e.ctx;return a.utils.parseSize(e.file.size)},modifiedtime:function(e){e=e.ctx;return a.utils.parseDate(e.file.lastModified)}},handler:{thumb:function(e){var t=e.node,e=e.ctx;return"img"===t.nodeName.toLowerCase()?t.setAttribute("src",e.thumb):t.style.backgroundImage="url("+e.thumb+")"}}}}}})})},set:function(e){var u,t,r,n=this;return this.fire("preview:loading"),this._.loader&&this._.loader.on(),e=[[],Array.isArray(e)?e:e.length?Array.from(e):[e]],u=e[0],t=e[1],(r=function(){var o;return(o=t.splice(0,1)[0])?new Promise(function(n,e){var i=new Image;return i.onerror=function(){var e;return u.push(e={thumb:a.assets.thumbholder,file:o}),n(e)},i.onload=function(){var e=[i.width,i.height],t=e[0],r=e[1];return 400<t&&(t=(e=[400,400*r/t])[0],r=e[1]),400<r&&(t=(e=[400*t/r,400])[0],r=e[1]),(e=document.createElement("canvas")).width=t,e.height=r,(e=e).getContext("2d").drawImage(i,0,0,t,r),e.toBlob(function(e){return u.push(e={thumb:URL.createObjectURL(e),file:o}),n(e)})},i.src=URL.createObjectURL(o)}).then(function(e){var t;return((t=n._).files||(t.files=[])).push(e),n._.view.render(),r()}):Promise.resolve(u)})().then(function(e){return n._.view.render(),n._.loader&&n._.loader.off(),n.fire("preview:loaded"),n.fire("file:chosen",n._.files),e})},get:function(){return this._.files},clear:function(){return this._.files.splice(0),this._.view.render()},progress:function(t){var r,e,n=this;if((r=null!=(e=t.item)?e.node:void 0)&&(e=ld$.find(r,"[ld=progress]")[0])&&(e.style.width=100*t.percent+"%",!(t.percent<1)))return debounce(500).then(function(){var e;if(r.parentNode&&r.parentNode.removeChild(r),~(e=n._.files.indexOf(t.item)))return n._.files.splice(e,1)})},upload:function(){var t=this;return a.ext[this._.opt.provider.host]({files:this._.files,progress:function(){return t.progress.call(t,arguments)},opt:this._.opt.provider.config}).then(function(e){return t.fire("upload:done",e),e}).catch(function(e){return t.fire("upload:fail",e),Promise.reject(e)})}}),a.viewer=function(e){var t,r,n,i=this;if(this._={evthdr:{},files:[],running:!1,i18n:e.i18n,root:"string"==typeof e.root?document.querySelector(e.root):e.root},this._.root||console.warn("[@plotdb/uploadr] warning: no node found for root ",e.root),this._.i18n)for(t in r=a.i18n)n=r[t],this._.i18n.addResourceBundle(t,"@plotdb/uploadr:viewer",n,!0,!0);return this._.view=new ldview({root:this._.root,action:{click:{load:function(){return i.fetch()},reset:function(){return i.reset()}}},init:{loader:function(e){e=e.node;if("undefined"!=typeof ldloader&&null!==ldloader)return i._.loader=new ldloader({root:e})}},handler:{load:function(e){return e.node.classList.toggle("d-none",!i._.page.fetchable())},end:function(e){return e.node.classList.toggle("d-none",!!i._.page.fetchable())},reset:function(e){return e.node.classList.toggle("d-none",!!i._.page.fetchable())},file:{list:function(){return i._.files||[]},key:function(e){return e._id},view:{action:{click:{"@":function(e){e=e.ctx;return i.fire("file:chosen",[e])}}},text:{name:function(e){return e.ctx.name||"unnamed"},size:function(e){e=e.ctx;return a.utils.parseSize(e.size)},modifiedtime:function(e){e=e.ctx;return a.utils.parseDate(e.lastModified)}},handler:{thumb:function(e){var t=e.node,e=e.ctx;if(t.dataset.src!==e.url)return"img"===t.nodeName.toLowerCase()?t.setAttribute("src",e.thumb):t.style.backgroundImage="url("+e.thumb+")",t.dataset.src=e.url}}}}}}),this._.page=e.page instanceof paginate?e.page:new paginate(e.page||{}),this._.page.on("fetch",function(e){var t=e.map(function(e){return e._id=Math.random().toString(36).substring(2),e});return Promise.all(t.map(function(n){return new Promise(function(e,t){var r=new Image;return r.onerror=function(){return n.thumb=a.assets.thumbholder,e()},r.onload=function(){return n.thumb=n.url,e()},r.src=n.url})})).then(function(){return debounce(2e3).then(function(){var e;return(e=i._).files=e.files.concat(t),i._.view.render(),i._.loader&&i._.loader.off(),i._.running=!1,i.fire("fetch:fetched",t)})})}),this._.page.on("finish",function(){return i._.running=!1,i.fire("fetch:end")}),this._.page.on("empty",function(){return i._.running=!1,i.fire("fetch:empty")}),this},a.viewer.prototype=o(Object.create(Object.prototype),{on:function(e,r){var n=this;return(Array.isArray(e)?e:[e]).map(function(e){var t;return((t=n._.evthdr)[e]||(t[e]=[])).push(r)})},fire:function(e){for(var t,r,n,i,o=[],u=[],a=1,l=arguments.length;a<l;++a)u.push(arguments[a]);for(t=u,a=0,n=(r=this._.evthdr[e]||[]).length;a<n;++a)i=r[a],o.push(i.apply(this,t));return o},fetch:function(){if(!this._.running&&this._.page.fetchable())return this._.loader.on(),this._.running=!0,this._.page.fetch()},reset:function(){var e=this;return this._.page.reset().then(function(){return e._.files=[],e._.view.render()})},i18n:function(r){var n=this;if(this._.i18n)return Array.from(this._.root.querySelectorAll("[t]")).map(function(e){var t;return(t=e.getAttribute("t"))||e.setAttribute("t",t=e.textContent),e.textContent=n._.i18n.t(t,{ns:"@plotdb/uploadr:viewer",lng:r})})}}),"undefined"!=typeof module&&null!==module?module.exports=a:"undefined"!=typeof window&&null!==window&&(window.uploadr=a)}.call(this);
