!function(){var i,u,e,n;function c(e,t){var n,r={}.hasOwnProperty;for(n in t)r.call(t,n)&&(e[n]=t[n]);return e}i=function(e){return e?new Date(e).toLocaleString("zh-TW",{timeZoneName:"short",hour12:!1}).replace(/[\[\]]/g,""):"n/a"},u=function(e){var t,n,r;return!(e=+(e=null==e?0:e))||isNaN(e)?"0 B":(t=["B","KB","MB","GB","TB","PB"],n=(n=Math.floor(Math.log(e)/Math.log(1024)))<(r=t.length)?n:r,(e/Math.pow(1024,n)).toFixed(1)+(t[n]||""))},(e=function(e){var r=this;return this.root="string"==typeof(e=null==e?{}:e).root?document.querySelector(e.root):e.root,this.root||console.warn("[uploadr] warning: no node found for root ",e.root),this.evtHandler={},this.opt=c({},e),this.opt.provider=e.provider||{host:"native",config:{route:"/d/uploadr"}},this.progress=function(t){var n,e;if((n=(t.item||(t.item={})).node)&&(e=ld$.find(n,"[ld=progress]")[0]))return e.style.width=100*t.percent+"%",1<=t.percent?debounce(500).then(function(){var e;if(ld$.remove(n),~(e=r.lc.files.indexOf(t.item)))return r.lc.files.splice(e,1)}):void 0},this.lc={files:[]},this.init=proxise.once(function(){return r._init()}),this.init(),this}).prototype=c(Object.create(Object.prototype),{on:function(e,t){var n;return((n=this.evtHandler)[e]||(n[e]=[])).push(t)},fire:function(e){for(var t,n,r,i,o=[],u=[],c=1,l=arguments.length;c<l;++c)u.push(arguments[c]);for(t=u,c=0,r=(n=this.evtHandler[e]||[]).length;c<r;++c)i=n[c],o.push(i.apply(this,t));return o},_init:function(){var o=this;return Promise.resolve().then(function(){var n,r=o.lc,l=function(e){var i=n.get("preview"),t=e.map(function(r){return new Promise(function(t,e){var n=new Image;return n.onload=function(){var e;return i&&((e=i.style).backgroundImage="url("+r.thumb+")",e.width=n.width+"px",e.height=n.height+"px"),t(c(((e={}).width=n.width,e.height=n.height,e),r))},n.src=r.thumb})});return Promise.all(t).then(function(){return r.files=(r.files||[]).concat(e),debounce(500)}).then(function(){return n.render(),o.fire("preview.done"),o.lc.loader&&o.lc.loader.off(),o.fire("file.chosen",r.files)})},t=function(n){return o.fire("preview.loading"),o.lc.loader&&o.lc.loader.on(),n=Array.from(n),new Promise(function(t,e){var u=[],c=function(r){var e,i,o=r.splice(0,1)[0];return o?(e=URL.createObjectURL(o),(i=new Image).onerror=function(){var e;return u.push(e={thumb:"data:image/svg+xml,"+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150">\n  <rect width="200" height="150" x="0" y="0" fill="#ccc"/>\n</svg>'),file:o}),l([e]),c(r)},i.onload=function(){var e=[i.width,i.height],t=e[0],n=e[1];return 200<t&&(t=(e=[200,200*n/t])[0],n=e[1]),150<n&&(t=(e=[150*t/n,150])[0],n=e[1]),(e=document.createElement("canvas")).width=t,e.height=n,e.getContext("2d").drawImage(i,0,0,t,n),e.toBlob(function(e){return u.push(e={thumb:URL.createObjectURL(e),file:o}),l([e]),c(r)})},i.src=e):t(u)};return c(n)})};return o.lc.view=n=new ldView({root:o.root,action:{input:{input:function(e){var n=e.node;return t(n.files).then(function(e){var t;if(n.value=null,t=n.form)return t.reset()})}},click:{upload:function(e){e.node;return o.upload().then(function(e){return o.clear(),e})},clear:function(e){e.node;return o.clear()}},drop:{drop:function(e){e.node;e=e.evt;return e.preventDefault(),t(e.dataTransfer.files)}},dragover:{drop:function(e){e.node;return e.evt.preventDefault()}}},init:{loader:function(e){e=e.node;return o.lc.loader=new ldloader({root:e})}},handler:{file:{list:function(){return r.files||[]},view:{action:{click:{delete:function(e){var e=e.ctx;if(~(e=r.files.indexOf(e)))return r.files.splice(e,1),r.view.render("file")}}},text:{name:function(e){return e.ctx.file.name},size:function(e){e=e.ctx;return u(e.file.size)},modifiedtime:function(e){e=e.ctx;return i(e.file.lastModified)}},handler:{thumb:function(e){var t=e.node,e=e.ctx;return"img"===t.nodeName.toLowerCase()?t.setAttribute("src",e.thumb):t.style.backgroundImage="url("+e.thumb+")"}}}}}})})},get:function(){return this.lc.files},clear:function(){return this.lc.files.splice(0),this.lc.view.render()},upload:function(){var t=this;return n[this.opt.provider.host]({files:this.lc.files,progress:this.progress,opt:this.opt.provider.config}).then(function(e){return t.fire("upload.done",e),e}).catch(function(e){return t.fire("upload.fail",e),Promise.reject(e)})}}),e.ext=n={},(e.viewer=function(e){var t,n,r=this;return this.root="string"==typeof e.root?document.querySelector(e.root):e.root,this.root||console.warn("[uploadr] warning: no node found for root ",e.root),this.evtHandler={},this.lc=t={},this.files=t.files=[],this.view=n=new ldView({root:this.root,action:{click:{load:function(e){e.node;return r.page.fetch()},listx:function(e){var t=e.node;if(e=ld$.parent(e.evt.target,"[data-src]",t))return t=e.getAttribute("data-src"),r.fire("choose",{url:t})}}},handler:{file:{list:function(){return t.files||[]},key:function(e){return e._id},view:{action:{click:{"@":function(e){e=e.ctx;return r.fire("choose",e)}}},text:{name:function(e){return e.ctx.name||"unnamed"},size:function(e){e=e.ctx;return u(e.size)},modifiedtime:function(e){e=e.ctx;return i(e.lastModified)}},handler:{thumb:function(e){var t=e.node,e=e.ctx;if(t._load!==e.url)return t._load=e.url,t.style.opacity=0,"img"===t.nodeName.toLowerCase()?(t.setAttribute("src",e.url),t.onload=function(){return ld$.find(t.parentNode,"div[ld=thumb]").map(function(e){return e.style.opacity=1})}):t.style.backgroundImage="url("+e.url+")",t.setAttribute("data-src",e.url)}}}}}}),this.page=e.page instanceof paginate?e.page:new paginate(e.page||{}),this.page.on("fetch",function(e){e=e.map(function(e){return e._id=Math.random(),e});return t.files=t.files.concat(e),n.render(),r.fire("fetch",e)}),this.page.on("finish",function(){return r.fire("finish")}),this.page.on("empty",function(){return r.fire("empty")}),this}).prototype=c(Object.create(Object.prototype),{on:function(e,t){var n;return((n=this.evtHandler)[e]||(n[e]=[])).push(t)},fire:function(e){for(var t,n,r,i,o=[],u=[],c=1,l=arguments.length;c<l;++c)u.push(arguments[c]);for(t=u,c=0,r=(n=this.evtHandler[e]||[]).length;c<r;++c)i=n[c],o.push(i.apply(this,t));return o},fetch:function(){return this.page.fetch()},reset:function(){return this.page.reset(),this.lc.files=[],this.view.render()}}),"undefined"!=typeof module&&null!==module?module.exports=e:"undefined"!=typeof window&&null!==window&&(window.uploadr=e)}.call(this);
