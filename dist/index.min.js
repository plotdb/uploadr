!function(){var i,u,e,r;function l(e,t){var r,n={}.hasOwnProperty;for(r in t)n.call(t,r)&&(e[r]=t[r]);return e}i=function(e){return e?new Date(e).toLocaleString("zh-TW",{timeZoneName:"short",hour12:!1}).replace(/[\[\]]/g,""):"n/a"},u=function(e){var t,r,n;return!(e=+(e=null==e?0:e))||isNaN(e)?"0 B":(t=["B","KB","MB","GB","TB","PB"],r=(r=Math.floor(Math.log(e)/Math.log(1024)))<(n=t.length)?r:n,(e/Math.pow(1024,r)).toFixed(1)+(t[r]||""))},(e=function(e){var n=this;return this.root="string"==typeof(e=null==e?{}:e).root?document.querySelector(e.root):e.root,this.root||console.warn("[uploadr] warning: no node found for root ",e.root),this.evtHandler={},this.opt=l({},e),this.opt.provider=e.provider||{host:"native",config:{route:"/d/uploadr"}},this.progress=function(t){var r,e;if((r=(t.item||(t.item={})).node)&&(e=ld$.find(r,"[ld=progress]")[0]))return e.style.width=100*t.percent+"%",1<=t.percent?debounce(500).then(function(){var e;if(ld$.remove(r),~(e=n.lc.files.indexOf(t.item)))return n.lc.files.splice(e,1)}):void 0},this.lc={files:[]},this.init=proxise.once(function(){return n._init()}),this.init(),this}).prototype=l(Object.create(Object.prototype),{on:function(e,t){var r;return((r=this.evtHandler)[e]||(r[e]=[])).push(t)},fire:function(e){for(var t,r,n,i,o=[],u=[],l=1,a=arguments.length;l<a;++l)u.push(arguments[l]);for(t=u,l=0,n=(r=this.evtHandler[e]||[]).length;l<n;++l)i=r[l],o.push(i.apply(this,t));return o},_init:function(){var o=this;return Promise.resolve().then(function(){var r,n=o.lc,a=function(e){var i=r.get("preview"),t=e.map(function(n){return new Promise(function(t,e){var r=new Image;return r.onload=function(){var e;return i&&((e=i.style).backgroundImage="url("+n.thumb+")",e.width=r.width+"px",e.height=r.height+"px"),t(l(((e={}).width=r.width,e.height=r.height,e),n))},r.src=n.thumb})});return Promise.all(t).then(function(){return n.files=(n.files||[]).concat(e),debounce(500)}).then(function(){return r.render(),o.fire("preview.done"),o.lc.loader&&o.lc.loader.off(),o.fire("file.chosen",n.files)})},t=function(r){return o.fire("preview.loading"),o.lc.loader&&o.lc.loader.on(),r=Array.from(r),new Promise(function(t,e){var u=[],l=function(n){var e,i,o=n.splice(0,1)[0];return o?(e=URL.createObjectURL(o),(i=new Image).onerror=function(){var e;return u.push(e={thumb:"data:image/svg+xml,"+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="200" height="150" viewBox="0 0 200 150">\n  <rect width="200" height="150" x="0" y="0" fill="#ccc"/>\n</svg>'),file:o}),a([e]),l(n)},i.onload=function(){var e=[i.width,i.height],t=e[0],r=e[1];return 200<t&&(t=(e=[200,200*r/t])[0],r=e[1]),150<r&&(t=(e=[150*t/r,150])[0],r=e[1]),(e=document.createElement("canvas")).width=t,e.height=r,e.getContext("2d").drawImage(i,0,0,t,r),e.toBlob(function(e){return u.push(e={thumb:URL.createObjectURL(e),file:o}),a([e]),l(n)})},i.src=e):t(u)};return l(r)})};return o.lc.view=r=new ldview({root:o.root,action:{input:{input:function(e){var r=e.node;return t(r.files).then(function(e){var t;if(r.value=null,t=r.form)return t.reset()})}},click:{upload:function(e){e.node;return o.upload().then(function(e){return o.clear(),e})},clear:function(e){e.node;return o.clear()}},drop:{drop:function(e){e.node;e=e.evt;return e.preventDefault(),t(e.dataTransfer.files)}},dragover:{drop:function(e){e.node;return e.evt.preventDefault()}}},init:{loader:function(e){e=e.node;return o.lc.loader=new ldloader({root:e})}},handler:{file:{list:function(){return n.files||[]},view:{action:{click:{delete:function(e){var e=e.ctx;if(~(e=n.files.indexOf(e)))return n.files.splice(e,1),n.view.render("file")}}},text:{name:function(e){return e.ctx.file.name},size:function(e){e=e.ctx;return u(e.file.size)},modifiedtime:function(e){e=e.ctx;return i(e.file.lastModified)}},handler:{thumb:function(e){var t=e.node,e=e.ctx;return"img"===t.nodeName.toLowerCase()?t.setAttribute("src",e.thumb):t.style.backgroundImage="url("+e.thumb+")"}}}}}})})},get:function(){return this.lc.files},clear:function(){return this.lc.files.splice(0),this.lc.view.render()},upload:function(){var t=this;return r[this.opt.provider.host]({files:this.lc.files,progress:this.progress,opt:this.opt.provider.config}).then(function(e){return t.fire("upload.done",e),e}).catch(function(e){return t.fire("upload.fail",e),Promise.reject(e)})}}),e.ext=r={},(e.viewer=function(e){var t,r,n=this;return this.root="string"==typeof e.root?document.querySelector(e.root):e.root,this.root||console.warn("[uploadr] warning: no node found for root ",e.root),this.evtHandler={},this.lc=t={},this.files=t.files=[],this.view=r=new ldview({root:this.root,action:{click:{load:function(e){e.node;return n.page.fetch()},listx:function(e){var t=e.node;if(e=ld$.parent(e.evt.target,"[data-src]",t))return t=e.getAttribute("data-src"),n.fire("choose",{url:t})}}},handler:{file:{list:function(){return t.files||[]},key:function(e){return e._id},view:{action:{click:{"@":function(e){e=e.ctx;return n.fire("choose",e)}}},text:{name:function(e){return e.ctx.name||"unnamed"},size:function(e){e=e.ctx;return u(e.size)},modifiedtime:function(e){e=e.ctx;return i(e.lastModified)}},handler:{thumb:function(e){var t=e.node,e=e.ctx;if(t._load!==e.url)return t._load=e.url,t.style.opacity=0,"img"===t.nodeName.toLowerCase()?(t.setAttribute("src",e.url),t.onload=function(){return ld$.find(t.parentNode,"div[ld=thumb]").map(function(e){return e.style.opacity=1})}):t.style.backgroundImage="url("+e.url+")",t.setAttribute("data-src",e.url)}}}}}}),this.page=e.page instanceof paginate?e.page:new paginate(e.page||{}),this.page.on("fetch",function(e){e=e.map(function(e){return e._id=Math.random(),e});return t.files=t.files.concat(e),r.render(),n.fire("fetch",e)}),this.page.on("finish",function(){return n.fire("finish")}),this.page.on("empty",function(){return n.fire("empty")}),this}).prototype=l(Object.create(Object.prototype),{on:function(e,t){var r;return((r=this.evtHandler)[e]||(r[e]=[])).push(t)},fire:function(e){for(var t,r,n,i,o=[],u=[],l=1,a=arguments.length;l<a;++l)u.push(arguments[l]);for(t=u,l=0,n=(r=this.evtHandler[e]||[]).length;l<n;++l)i=r[l],o.push(i.apply(this,t));return o},fetch:function(){return this.page.fetch()},reset:function(){return this.page.reset(),this.lc.files=[],this.view.render()}}),e.i18n={en:{"Drag & drop":"Drag & drop","file(s) here":"file(s) here",Name:"Name",Size:"Size","Modified Date":"Modified Date","Add File ...":"Add File ...",div:"div",Upload:"Upload",Clear:"Clear",Close:"Close","Load More":"Load More"},"zh-TW":{"Drag & drop":"拖拉檔案","file(s) here":"至此處",Name:"檔名",Size:"檔案大小","Modified Date":"修改時間","Add File ...":"增加檔案 ...",Upload:"上傳",Clear:"清除",Close:"關閉","Load More":"載入更多"}},"undefined"!=typeof module&&null!==module?module.exports=e:"undefined"!=typeof window&&null!==window&&(window.uploadr=e)}.call(this);
