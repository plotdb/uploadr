#!/usr/bin/env bash
rm -rf dist
mkdir -p dist/providers dist/server/providers
echo "build src/client.ls -> dist/index.js ..."
./node_modules/.bin/lsc -cp --no-header src/client.ls > dist/index.js
echo "minifying index.js ..."
./node_modules/.bin/uglifyjs dist/index.js -m -c > dist/index.min.js

for dir in gcs native dummy imgbb
do
  echo "build src/providers/$dir/client.ls -> dist/providers/$dir/index.js ..."
  mkdir -p dist/providers/$dir
  ./node_modules/.bin/lsc -cp --no-header src/providers/$dir/client.ls > dist/providers/$dir/index.js
  echo "minifying dist/providers/$dir/index.js ..."
  ./node_modules/.bin/uglifyjs dist/providers/$dir/index.js -m -c > dist/providers/$dir/index.min.js
  if [ -f "src/providers/$dir/server.ls" ]; then
    echo "build src/providers/$dir/server.ls -> dist/server/providers/$dir/index.js ..."
    mkdir -p dist/server/providers/$dir
    ./node_modules/.bin/lsc -cp --no-header src/providers/$dir/server.ls > dist/server/providers/$dir/index.js
  fi
done

echo "build src/client.styl -> dist/index.css ..."
./node_modules/.bin/stylus -p src/client.styl > dist/index.css
echo "minifying index.css ..."
./node_modules/.bin/uglifycss dist/index.css > dist/index.min.css

echo "build src/server.ls -> dist/server/index.js ..."
./node_modules/.bin/lsc -cbp src/server.ls > dist/server/index.js

echo "build src/block/uploader/index.pug -> dist/index.html"
./node_modules/.bin/srcbuild-pug src/block/uploader/index.pug > dist/index.html
echo "build src/block/viewer/index.pug -> dist/viewer"
mkdir -p dist/viewer
./node_modules/.bin/srcbuild-pug src/block/viewer/index.pug > dist/viewer/index.html

echo "copy pug file to dist/ ..."
cp src/client.pug dist/server/index.pug

echo "deploy into local web ..."
rm -rf web/static/assets/lib/@plotdb/uploadr/dev/
mkdir -p web/static/assets/lib/@plotdb/uploadr/dev/
cp -R dist/* web/static/assets/lib/@plotdb/uploadr/dev/
echo "done."
